&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Добавить реквизиты
	Реквизиты = Новый Массив;
	
	Реквизиты.Добавить(Новый РеквизитФормы("СуммаВсегоРегл", Новый ОписаниеТипов("Число", , Новый КвалификаторыЧисла(15, 2)), "Объект.Товары"));
	Реквизиты.Добавить(Новый РеквизитФормы("ОбщаяСуммаВсегоРегл", Новый ОписаниеТипов("Число", , Новый КвалификаторыЧисла(15, 2))));
	
	ИзменитьРеквизиты(Реквизиты);
	
    // Вывести реквизиты на форму
    СуммаВсегоРегл = Элементы.Добавить("СуммаВсегоРегл", Тип("ПолеФормы"), Элементы.Товары);
    СуммаВсегоРегл.Вид = ВидПоляФормы.ПолеНадписи;
    СуммаВсегоРегл.ПутьКДанным = "Объект.Товары.СуммаВсегоРегл";
    
    ОбщаяСуммаВсегоРегл = Элементы.Добавить("ОбщаяСуммаВсегоРегл", Тип("ПолеФормы"), Элементы.ГруппаИтоги);
    ОбщаяСуммаВсегоРегл.Вид = ВидПоляФормы.ПолеНадписи;
    ОбщаяСуммаВсегоРегл.ПутьКДанным = "ОбщаяСуммаВсегоРегл";
    
КонецПроцедуры

&НаКлиенте
Процедура ВвестиДопРасходы(Команда)
    
    Оповещение = Новый ОписаниеОповещения("ПослеВводаДопРасходы", ЭтотОбъект);
    ПоказатьВводЧисла(Оповещение, , "Введите дополнительные расходы", 15, 2);

КонецПроцедуры

&НаКлиенте
Процедура ПослеВводаДопРасходы(Сумма, Параметры) Экспорт
    Если Сумма <> Неопределено Тогда
        
        Коэффициенты = Новый Массив;
        Для Каждого Элемент Из Объект.Товары Цикл
            Коэффициенты.Добавить(Элемент.Сумма);
        КонецЦикла;
        
        РаспределитьСумму(Коэффициенты, Сумма, 2);
        
    КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура РаспределитьСумму(Коэффициенты, Сумма, Округление = 2)
    
    ОбщийКоэффициент = 0;
    Для Каждого Коэффициент Из Коэффициенты Цикл
        ОбщийКоэффициент = ОбщийКоэффициент + Коэффициент;
    КонецЦикла;
    
    Если ОбщийКоэффициент = 0 Тогда
        Возврат;
    КонецЕсли;
    
    Остаток = Сумма;
    Для Инд = 0 По Коэффициенты.ВГраница() Цикл
        Элемент = Объект.Товары[Инд];
        
        Доля = Коэффициенты[Инд] / ОбщийКоэффициент;
        Элемент.СуммаДопРасходы = Доля * Сумма;
        
        // Округление
        Элемент.СуммаДопРасходы = Окр(Элемент.СуммаДопРасходы, Округление);
        
        Остаток = Остаток - Элемент.СуммаДопРасходы;
    КонецЦикла;
    
    // Коррекция остатка
    Объект.Товары[0].СуммаДопРасходы = Объект.Товары[0].СуммаДопРасходы + Остаток;
    
КонецПроцедуры

&НаКлиенте
Процедура ТоварыКоличествоПриИзменении(Элемент)
	Элементы.Товары.ТекущиеДанные.Сумма = Элементы.Товары.ТекущиеДанные.Количество * Элементы.Товары.ТекущиеДанные.Цена;
	Элементы.Товары.ТекущиеДанные.СуммаВсего = Элементы.Товары.ТекущиеДанные.Сумма + Элементы.Товары.ТекущиеДанные.СуммаДопРасходы;
КонецПроцедуры

&НаКлиенте
Процедура ТоварыЦенаПриИзменении(Элемент)
	Элементы.Товары.ТекущиеДанные.Сумма = Элементы.Товары.ТекущиеДанные.Количество * Элементы.Товары.ТекущиеДанные.Цена;
	Элементы.Товары.ТекущиеДанные.СуммаВсего = Элементы.Товары.ТекущиеДанные.Сумма + Элементы.Товары.ТекущиеДанные.СуммаДопРасходы;
КонецПроцедуры

&НаКлиенте
Процедура ТоварыСуммаДопРасходыПриИзменении(Элемент)
	Элементы.Товары.ТекущиеДанные.СуммаВсего = Элементы.Товары.ТекущиеДанные.Сумма + Элементы.Товары.ТекущиеДанные.СуммаДопРасходы;
КонецПроцедуры

&НаКлиенте
Процедура ТоварыСуммаВсегоПриИзменении(Элемент)
	// Обработка изменения СуммаВсего
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьРеквизитыРегламентированногоУчета()
    Если Объект.Дата <> Неопределено И Объект.Валюта <> Неопределено Тогда
        КурсВалюты = ПолучитьКурсВалюты(Объект.Валюта, Объект.Дата);
        
        Для Каждого Элемент Из Объект.Товары Цикл
            Элемент.СуммаВсегоРегл = Окр(Элемент.СуммаВсего * КурсВалюты.Курс / КурсВалюты.Кратность, 2);
        КонецЦикла;
        
        ОбщаяСуммаВсегоРегл = 0;
        Для Каждого Элемент Из Объект.Товары Цикл
            ОбщаяСуммаВсегоРегл = ОбщаяСуммаВсегоРегл + Элемент.СуммаВсегоРегл;
        КонецЦикла;
        
    КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ВалютаПриИзменении(Элемент)
    ЗаполнитьРеквизитыРегламентированногоУчета();
КонецПроцедуры

&НаКлиенте
Процедура ТоварыСуммаВсегоПриИзменении(Элемент)
    ЗаполнитьРеквизитыРегламентированногоУчета();
КонецПроцедуры

&НаСервере
Функция ПолучитьКурсВалюты(Валюта, Дата)
    РС = СоздатьОбъект("ИнформационныйРегистр. КурсыВалют");
    РС.Периодический = Истина;
    
    Знач РСВыборка = РС.Выбрать(Дата, Валюта);
    Если РСВыборка.Существует() Тогда
        Возврат РСВыборка;
    Иначе
        Возврат Неопределено;
    КонецЕсли;
КонецФункции
