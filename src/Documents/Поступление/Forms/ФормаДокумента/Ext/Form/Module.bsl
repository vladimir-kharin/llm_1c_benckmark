
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)

	// Создаем массив реквизитов
	Рекв = Новый Массив;

	// Добавляем реквизит "ОбщаяСуммаВсегоРегл" на форму
	Рекв.Добавить(Новый РеквизитФормы("ОбщаяСуммаВсегоРегл", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2))));

	// Добавляем реквизит "СуммаВсегоРегл" в табличную часть "Товары"
	Рекв.Добавить(Новый РеквизитФормы("СуммаВсегоРегл", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)), "Объект.Товары"));

	// Применяем реквизиты
	ИзменитьРеквизиты(Рекв);

	// Добавляем поле на форму
	Элементы.Форма.ГруппаИтоги.Добавить("ПолеОбщаяСуммаВсегоРегл", Тип("ПолеФормы"));
	Элементы.Форма.ПолеОбщаяСуммаВсегоРегл.ПутьКДанным = "ОбщаяСуммаВсегоРегл";
	Элементы.Форма.ПолеОбщаяСуммаВсегоРегл.Вид = ВидПоляФормы.ПолеВвода;

КонецПроцедуры

&НаКлиенте
Процедура ВвестиДопРасходы(Команда)

    Оповещение = Новый ОписаниеОповещения("ПослеВводаСуммы", ЭтотОбъект);

    ПоказатьВводЧисла(Оповещение, , "Укажите сумму дополнительных расходов", 15, 2);

КонецПроцедуры

&НаКлиенте
Процедура ПослеВводаСуммы(Сумма, Параметры) Экспорт
    Если Сумма <> Неопределено Тогда
        // Получаем табличную часть документа
        Товары = Объект.Товары;

        // Формируем коэффициенты на основе суммы каждой строки
        Коэффициенты = Новый Массив;
        Для Каждого Строка Из Товары Цикл
            Коэффициенты.Добавить(Строка.Сумма);
        КонецЦикла;
        
        // Распределяем сумму по базе
        СуммаДопРасходовПоСтрокам = РаспределитьСуммуПоБазе(Сумма, Коэффициенты);
        
        // Записываем результат в поле СуммаДопРасходы для всех строк
        Для Индекс = 0 По Товары.Количество() - 1 Цикл
            Товары[Индекс].СуммаДопРасходы = СуммаДопРасходовПоСтрокам[Индекс];
        КонецЦикла;
        
        // Пересчитываем все строки в табличной части
        Для Каждого Строка Из Товары Цикл
            Строка.СуммаВсего = Строка.Сумма + Строка.СуммаДопРасходы;
        КонецЦикла;
    КонецЕсли;
КонецПроцедуры

&НаКлиенте
Функция РаспределитьСуммуПоБазе(Сумма, Коэффициенты, КоличествоЗнаковОкругления = 2)
    
    ОбщаяСуммаКоэффициентов = 0;
    Для Каждого Коэффициент Из Коэффициенты Цикл
        ОбщаяСуммаКоэффициентов = ОбщаяСуммаКоэффициентов + Коэффициент;
    КонецЦикла;

    Результат = Новый Массив;
    Для Каждого Коэффициент Из Коэффициенты Цикл
        Доля = Коэффициент / ОбщаяСуммаКоэффициентов;
        СуммаПоСтроке = Сумма * Доля;
        СуммаПоСтроке = Окр(СуммаПоСтроке, КоличествоЗнаковОкругления);
        Результат.Добавить(СуммаПоСтроке);
    КонецЦикла;

    // Корректировка на ошибки округления
    Разница = Сумма - СуммаСтрок(Результат);
    Если Разница <> 0 Тогда
        Результат[0] = Результат[0] + Разница;
    КонецЕсли;
    
    Возврат Результат;

КонецФункции

&НаКлиенте
Функция СуммаСтрок(Массив)
    Сумма = 0;
    Для Каждого Элемент Из Массив Цикл
        Сумма = Сумма + Элемент;
    КонецЦикла;
    Возврат Сумма;
КонецФункции

&НаКлиенте
Процедура ТоварыКоличествоПриИзменении(Элемент)
	ПересчитатьСуммыСтроки();
КонецПроцедуры

&НаКлиенте
Процедура ТоварыЦенаПриИзменении(Элемент)
	ПересчитатьСуммыСтроки();
КонецПроцедуры

&НаКлиенте
Процедура ТоварыСуммаДопРасходыПриИзменении(Элемент)
	ПересчитатьСуммыСтроки();
КонецПроцедуры

&НаКлиенте
Процедура ТоварыСуммаВсегоПриИзменении(Элемент)
	// Ничего не делаем, так как это вычисляемое поле
КонецПроцедуры

&НаКлиенте
Процедура ПересчитатьСуммыСтроки()
	СтрокаТабличнойЧасти = Элементы.Товары.ТекущиеДанные;
	Если СтрокаТабличнойЧасти = Неопределено Тогда
		Возврат;
	КонецЕсли;

	Количество = СтрокаТабличнойЧасти.Количество;
	Цена = СтрокаТабличнойЧасти.Цена;
	СуммаДопРасходы = СтрокаТабличнойЧасти.СуммаДопРасходы;

	СтрокаТабличнойЧасти.Сумма = Количество * Цена;
	СтрокаТабличнойЧасти.СуммаВсего = СтрокаТабличнойЧасти.Сумма + СуммаДопРасходы;
КонецПроцедуры

&НаКлиенте
Процедура ВалютаПриИзменении(Элемент)
	// Вставить содержимое обработчика.
КонецПроцедуры
