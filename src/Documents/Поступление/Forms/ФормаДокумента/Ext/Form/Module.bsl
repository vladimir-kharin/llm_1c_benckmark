
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	//Вставить содержимое обработчика
КонецПроцедуры

&НаКлиенте
Процедура ВвестиДопРасходы(Команда)
	// Создаем описание оповещения для обработки результата
	Оповещение = Новый ОписаниеОповещения("ПослеВводаДопРасходы", ЭтотОбъект);
	// Показываем диалог ввода значения
	ПоказатьВводЗначения(
		Оповещение,
		, // без начального значения
		"Введите сумму доп. расходов",
		"Число");
КонецПроцедуры

&НаКлиенте
Процедура ТоварыКоличествоПриИзменении(Элемент)
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	ТекущаяСтрока.Сумма = ТекущаяСтрока.Количество * ТекущаяСтрока.Цена;
	ТекущаяСтрока.СуммаВсего = ТекущаяСтрока.Сумма + ТекущаяСтрока.СуммаДопРасходы;
КонецПроцедуры

&НаКлиенте
Процедура ТоварыЦенаПриИзменении(Элемент)
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	ТекущаяСтрока.Сумма = ТекущаяСтрока.Количество * ТекущаяСтрока.Цена;
	ТекущаяСтрока.СуммаВсего = ТекущаяСтрока.Сумма + ТекущаяСтрока.СуммаДопРасходы;
КонецПроцедуры

&НаКлиенте
Процедура ТоварыСуммаДопРасходыПриИзменении(Элемент)
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	ТекущаяСтрока.СуммаВсего = ТекущаяСтрока.Сумма + ТекущаяСтрока.СуммаДопРасходы;
КонецПроцедуры

&НаКлиенте
Процедура ПересчитатьИтоговуюСумму() Экспорт
	// Получаем все строки табличной части
	Строки = Элементы.Товары.ТекущиеДанные;
	
	// Проверяем наличие строк
	Если Строки.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	// Формируем массив коэффициентов
	Коэффициенты = Новый Массив(Строки.Количество());
	СуммаБазы = 0;
	Для Ном = 0 По Строки.Количество() - 1 Цикл
		Строка = Строки[Ном];
		Коэффициенты[Ном] = Строка.Сумма;
		СуммаБазы = СуммаБазы + Строка.Сумма;
	КонецЦикла;
	
	// Проверяем ненулевую базу
	Если СуммаБазы = 0 Тогда
		Возврат;
	КонецЕсли;
	
	// Выполняем распределение
	ДопРасходы = Элементы.ДопРасходы.Значение;
	Распределенные = РаспределитьПоБазе(Коэффициенты, ДопРасходы, 2);
	
	// Применяем результаты
	Для Ном = 0 По Строки.Количество() - 1 Цикл
		Строка = Строки[Ном];
		Строка.СуммаДопРасходы = Распределенные[Ном];
	КонецЦикла;
	
	// Обновляем итоговую сумму
	ОбновитьИтоговуюСумму();
КонецПроцедуры

&НаКлиенте
Функция РаспределитьПоБазе(Коэффициенты, Сумма, КоличествоЗнаков = 2) Экспорт
	Результат = Новый Массив(Коэффициенты.Количество());
	
	// Проверяем нулевую сумму
	Если Сумма = 0 Тогда
		Возврат Результат;
	КонецЕсли;
	
	// Рассчитываем общую базу
	ОбщаяБаза = 0;
	Для Каждого Коэффициент Из Коэффициенты Цикл
		ОбщаяБаза = ОбщаяБаза + Коэффициент;
	КонецЦикла;
	
	// Проверяем нулевую базу
	Если ОбщаяБаза = 0 Тогда
		Возврат Результат;
	КонецЕсли;
	
	// Рассчитываем значения
	СуммаОкругленных = 0;
	Для Ном = 0 По Коэффициенты.Количество() - 1 Цикл
		// Рассчитываем значение для текущей позиции
		Значение = Сумма * (Коэффициенты[Ном] / ОбщаяБаза);
		// Округляем
		Округленное = Округл(Значение, КоличествоЗнаков);
		// Сохраняем
		Результат[Ном] = Округленное;
		// Учитываем в общей сумме
		СуммаОкругленных = СуммаОкругленных + Округленное;
	КонецЦикла;
	
	// Корректируем возможное расхождение
	Если Результат.Количество() > 0 Тогда
		Разница = Сумма - СуммаОкругленных;
		Результат[Результат.Количество() - 1] = Результат[Результат.Количество() - 1] + Разница;
	КонецЕсли;
	
	Возврат Результат;
КонецФункции

&НаКлиенте
Процедура ОбновитьИтоговуюСумму() Экспорт
	// Получаем все строки табличной части
	Строки = Элементы.Товары.ТекущиеДанные;
	
	// Проверяем наличие строк
	Если Строки.Количество() = 0 Тогда
		Элементы.ИтоговаяСумма.Значение = 0;
		Возврат;
	КонецЕсли;
	
	// Суммируем итоговые значения
	ОбщаяСумма = 0;
	Для Ном = 0 По Строки.Количество() - 1 Цикл
		Строка = Строки[Ном];
		ОбщаяСумма = ОбщаяСумма + Строка.СуммаВсего;
	КонецЦикла;
	
	// Обновляем итоговое поле
	Элементы.ИтоговаяСумма.Значение = ОбщаяСумма;
КонецПроцедуры

&НаКлиенте
Процедура ПослеВводаДопРасходы(ЗначениеДопРасходы, Параметры) Экспорт
	Если ЗначениеДопРасходы <> Неопределено Тогда
		// Обновляем значение доп. расходов
		Элементы.ДопРасходы.Значение = ЗначениеДопРасходы;
		
		// Пересчитываем распределение доп. расходов
		ПересчитатьИтоговуюСумму();
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ВалютаПриИзменении(Элемент)
	// Вставить содержимое обработчика.
КонецПроцедуры
