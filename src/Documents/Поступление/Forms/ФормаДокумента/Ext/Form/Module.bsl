
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	НовыеРеквизиты = Новый Массив;
	
	// Добавление реквизита "СуммаВсегоРегл" в табличную часть Товары
	НовыеРеквизиты.Добавить(Новый РеквизитФормы("СуммаВсегоРегл", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2)), "Объект.Товары"));
	
	// Добавление реквизита "ОбщаяСуммаВсегоРегл" на форму
	НовыеРеквизиты.Добавить(Новый РеквизитФормы("ОбщаяСуммаВсегоРегл", Новый ОписаниеТипов("Число", Новый КвалификаторыЧисла(15, 2))));
	
	ИзменитьРеквизиты(НовыеРеквизиты);
	
	// Вывод реквизита "СуммаВсегоРегл" в таблицу Товары
	КолонкаСуммаВсегоРегл = Элементы.Добавить("ТоварыСуммаВсегоРегл", Тип("ПолеФормы"), Элементы.Товары);
	КолонкаСуммаВсегоРегл.Вид = ВидПоляФормы.ПолеВвода;
	КолонкаСуммаВсегоРегл.ПутьКДанным = "Объект.Товары.СуммаВсегоРегл";
	
	// Размещение "ОбщаяСуммаВсегоРегл" в группе "ГруппаИтоги"
	ПолеОбщаяСуммаВсегоРегл = Элементы.Добавить("ОбщаяСуммаВсегоРегл", Тип("ПолеФормы"), Элементы.ГруппаИтоги);
	ПолеОбщаяСуммаВсегоРегл.Вид = ВидПоляФормы.ПолеВвода;
	ПолеОбщаяСуммаВсегоРегл.ПутьКДанным = "ОбщаяСуммаВсегоРегл";
КонецПроцедуры

&НаКлиенте
Процедура ВвестиДопРасходы(Команда)
	ПоказатьВводЧисла(Новый ОписаниеОповещения("ОбработкаВводаДопРасходов", ЭтаФорма), "Введите сумму дополнительных расходов");
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаВводаДопРасходов(ВведенноеЧисло, ДополнительныеПараметры) Экспорт
	Если ВведенноеЧисло <> Неопределено Тогда
		Коэффициенты = Новый Массив;
		Для каждого СтрокаТовары Из Объект.Товары Цикл
			Коэффициенты.Добавить(СтрокаТовары.Сумма);
		КонецЦикла;
		РаспределеннаяСумма = РаспределитьСуммуПоБазам(Коэффициенты, ВведенноеЧисло, 2);
		Индекс = 0;
		Для каждого СтрокаТовары Из Объект.Товары Цикл
			СтрокаТовары.СуммаДопРасходы = РаспределеннаяСумма[Индекс];
			Индекс = Индекс + 1;
		КонецЦикла;
		РассчитатьИтогиТаблицыТовары();
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьИтогиТаблицыТовары()
	Для каждого СтрокаТовары Из Объект.Товары Цикл
		СтрокаТовары.СуммаВсего = СтрокаТовары.Сумма + СтрокаТовары.СуммаДопРасходы;
	КонецЦикла;
	ПересчитатьСуммуВсегоРегл();
КонецПроцедуры

&НаСервере
Процедура ПересчитатьСуммуВсегоРегл()
	КурсВалютыДокумента = ПолучитьКурсВалюты(Объект.Валюта, Объект.Дата);
	Для каждого СтрокаТовары Из Объект.Товары Цикл
		СтрокаТовары.СуммаВсегоРегл = ПересчитатьВРеглВалюта(СтрокаТовары.СуммаВсего, КурсВалютыДокумента);
	КонецЦикла;
	
	ОбщаяСуммаВсегоРегл = 0;
	Для каждого СтрокаТовары Из Объект.Товары Цикл
		ОбщаяСуммаВсегоРегл = ОбщаяСуммаВсегоРегл + СтрокаТовары.СуммаВсегоРегл;
	КонецЦикла;
КонецПроцедуры

&НаСервере
Функция ПолучитьКурсВалюты(Валюта, Дата)
	Отбор = Новый Структура("Валюта", Валюта);
	ЗначенияРесурсов = РегистрыСведений.КурсыВалют.ПолучитьПоследнее(Дата, Отбор);
	Если ЗначенияРесурсов <> Неопределено Тогда
		Возврат ЗначенияРесурсов.Курс / ЗначенияРесурсов.Кратность;
	Иначе
		Возврат 0;
	КонецЕсли;
КонецФункции

&НаСервере
Функция ПересчитатьВРеглВалюта(Сумма, КурсВалютыДокумента)
	// Здесь предполагается, что регламентированная валюта - рубли (курс 1)
	Возврат Сумма * КурсВалютыДокумента;
КонецФункции

&НаСервереБезКонтекста
Функция РаспределитьСуммуПоБазам(КоэффициентыБазы, СуммаДляРаспределения, ЗнаковОкругления = 2)
	СуммаКоэффициентов = 0;
	Для каждого Коэффициент Из КоэффициентыБазы Цикл
		СуммаКоэффициентов = СуммаКоэффициентов + Коэффициент;
	КонецЦикла;
	
	Если СуммаКоэффициентов = 0 Тогда
		РаспределеннаяСумма = Новый Массив;
		Для Индекс = 1 По КоэффициентыБазы.Количество() Цикл
			РаспределеннаяСумма.Добавить(0);
		КонецЦикла;
		Возврат РаспределеннаяСумма;
	КонецЕсли;
	
	РаспределеннаяСумма = Новый Массив(КоэффициентыБазы.Количество());
	ОстатокСуммы = СуммаДляРаспределения;
	
	Для Индекс = 0 По КоэффициентыБазы.Количество() - 2 Цикл
		Доля = (КоэффициентыБазы[Индекс] / СуммаКоэффициентов) * СуммаДляРаспределения;
		ОкругленнаяДоля = Окр(Доля, ЗнаковОкругления);
		РаспределеннаяСумма[Индекс] = ОкругленнаяДоля;
		ОстатокСуммы = ОстатокСуммы - ОкругленнаяДоля;
	КонецЦикла;
	
	РаспределеннаяСумма[КоэффициентыБазы.Количество() - 1] = ОстатокСуммы;
	Возврат РаспределеннаяСумма;
КонецФункции

&НаКлиенте
Процедура ТоварыКоличествоПриИзменении(Элемент)
	РассчитатьСуммуТекущейСтроки();
	РассчитатьСуммуВсего();
КонецПроцедуры

&НаКлиенте
Процедура ТоварыЦенаПриИзменении(Элемент)
	РассчитатьСуммуТекущейСтроки();
	РассчитатьСуммуВсего();
КонецПроцедуры

&НаКлиенте
Процедура ТоварыСуммаДопРасходыПриИзменении(Элемент)
	РассчитатьСуммуВсего();
КонецПроцедуры

&НаКлиенте
Процедура ТоварыСуммаВсегоПриИзменении(Элемент)
	// Вставить содержимое обработчика, если необходимо
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьСуммуТекущейСтроки()
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	Если ТекущаяСтрока <> Неопределено Тогда
		ТекущаяСтрока.Сумма = ТекущаяСтрока.Количество * ТекущаяСтрока.Цена;
		РассчитатьСуммуВсего();
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьСуммуВсего()
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	Если ТекущаяСтрока <> Неопределено Тогда
		ТекущаяСтрока.СуммаВсего = ТекущаяСтрока.Сумма + ТекущаяСтрока.СуммаДопРасходы;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ВалютаПриИзменении(Элемент)
	// Вставить содержимое обработчика.
КонецПроцедуры
