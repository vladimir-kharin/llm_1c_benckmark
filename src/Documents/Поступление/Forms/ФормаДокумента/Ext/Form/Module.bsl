
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	//Вставить содержимое обработчика
КонецПроцедуры

&НаКлиенте
Процедура ВвестиДопРасходы(Команда)
    // Используем стандартный диалог ввода числа
    Оповещение = Новый ОписаниеОповещения("ПослеВводаДопРасходов", ЭтотОбъект);
    ПоказатьВводЧисла(Оповещение, , "Введите сумму доп. расходов", 12, 2);
КонецПроцедуры

&НаКлиенте
Процедура ПослеВводаДопРасходов(СуммаДопРасходов, Параметры) Экспорт
    Если СуммаДопРасходов <> Неопределено Тогда
        Объект.СуммаДопРасходы = СуммаДопРасходов;
        Объект.Оповестить("СуммаДопРасходы", Объект.СуммаДопРасходы);
        Товары.ПересчитатьИтоги();
        
        // Распределение суммы по базе
        МассивКоэффициентов = Новый Массив;
        Для Каждого Ряд Из Товары Цикл
            МассивКоэффициентов.Добавить(Ряд.База);
        КонецЦикла;
        
        РаспределенныеСуммы = РаспределитьСуммуПропорционально(МассивКоэффициентов, СуммаДопРасходов);
        Для Каждого i Из 0 По РаспределенныеСуммы.Количество() - 1 Цикл
            Товары[i].СуммаДопРасходы = РаспределенныеСуммы[i];
        КонецЦикла;
        
        // Вызов серверного обработчика
        Результат = Выполнить(ОбработкаДопРасходов, Объект.СуммаДопРасходы);
        Если Не Результат Тогда
            Предупреждение("Ошибка обработки доп. расходов");
        КонецЕсли;
    КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура РаспределитьСуммуПропорционально(МассивКоэффициентов, Сумма, КоличествоЗнаков = 2)
    ОбщаяСуммаКоэффициентов = СуммаМассива(МассивКоэффициентов);
    Если ОбщаяСуммаКоэффициентов = 0 Тогда
        Возврат Новый Массив;
    КонецЕсли;
    
    РезультирующийМассив = Новый Массив;
    ОбщаяРаспределеннаяСумма = 0;
    
    Для Каждого Коэффициент Из МассивКоэффициентов Цикл
        Доля = (Коэффициент / ОбщаяСуммаКоэффициентов) * Сумма;
        ОкругленнаяДоля = Округлить(Доля, КоличествоЗнаков);
        РезультирующийМассив.Добавить(ОкругленнаяДоля);
        ОбщаяРаспределеннаяСумма = ОбщаяРаспределеннаяСумма + ОкругленнаяДоля;
    КонецЦикла;
    
    // Корректировка на случай расхождений из-за округления
    Если ОбщаяРаспределеннаяСумма <> Сумма Тогда
        Разница = Сумма - ОбщаяРаспределеннаяСумма;
        // Распределяем разницу по первому элементу
        РезультирующийМассив[0] = РезультирующийМассив[0] + Разница;
    КонецЕсли;
    
    Возврат РезультирующийМассив;
КонецПроцедуры

&НаКлиенте
Процедура ТоварыКоличествоПриИзменении(Элемент)
    Ряд = Элемент.Родитель.ТекущиеДанные;
    Ряд.Сумма = Ряд.Количество * Ряд.Цена;
    Ряд.СуммаВсего = Ряд.Сумма + Ряд.СуммаДопРасходы;
КонецПроцедуры

&НаКлиенте
Процедура ТоварыЦенаПриИзменении(Элемент)
    Ряд = Элемент.Родитель.ТекущиеДанные;
    Ряд.Сумма = Ряд.Количество * Ряд.Цена;
    Ряд.СуммаВсего = Ряд.Сумма + Ряд.СуммаДопРасходы;
КонецПроцедуры

&НаКлиенте
Процедура ТоварыСуммаДопРасходыПриИзменении(Элемент)
    Ряд = Элемент.Родитель.ТекущиеДанные;
    Ряд.СуммаВсего = Ряд.Сумма + Ряд.СуммаДопРасходы;
КонецПроцедуры

&НаКлиенте
Процедура ТоварыСуммаВсегоПриИзменении(Элемент)
    // Обработка изменений СуммаВсего (если требуется)
КонецПроцедуры

&НаКлиенте
Процедура ВалютаПриИзменении(Элемент)
	// Вставить содержимое обработчика.
КонецПроцедуры
