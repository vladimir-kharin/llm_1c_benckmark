
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    // Добавляем реквизиты формы документа
    Рекв = Новый Массив;
    Рекв.Добавить(Новый РеквизитФормы("СуммаВсегоРегл", Новый ОписаниеТипов("Число", , Новый КвалификаторыЧисла(15, 2)), "Объект.Товары"));
    Рекв.Добавить(Новый РеквизитФормы("ОбщаяСуммаВсегоРегл", Новый ОписаниеТипов("Число", , Новый КвалификаторыЧисла(15, 2))));
    ИзменитьРеквизиты(Рекв);

    // Получаем таблицу "Товары"
    ТаблицаТовары = Элементы.Товары;
    
    // Добавляем реквизит "СуммаВсегоРегл" в таблицу
    СуммаВсегоРегл = Элементы.Добавить(
        "СуммаВсегоРегл", 
        Тип("ПолеФормы"), 
        ТаблицаТовары
    );
    СуммаВсегоРегл.Вид         = ВидПоляФормы.ПолеВвода;
    СуммаВсегоРегл.ПутьКДанным = "Объект.Товары.СуммаВсегоРегл";
    
    // Получаем группу "ГруппаИтоги"
    ГруппаИтоги = Элементы.ГруппаИтоги;
    
    // Добавляем реквизит "ОбщаяСуммаВсегоРегл" в группу
    ОбщаяСуммаВсегоРегл = Элементы.Добавить(
        "ОбщаяСуммаВсегоРегл", 
        Тип("ПолеФормы"), 
        ГруппаИтоги
    );
    ОбщаяСуммаВсегоРегл.Вид         = ВидПоляФормы.ПолеВвода;
    ОбщаяСуммаВсегоРегл.ПутьКДанным = "ОбщаяСуммаВсегоРегл";
    
    // Инициализация значений
    ПересчитатьСуммыРегл();
КонецПроцедуры

&НаСервере
Процедура ПересчитатьСуммыРегл()
    Если Объект.Валюта <> Неопределено Тогда
        // Получаем курс валюты на дату документа
ЗаписьКурсы = КурсыВалют.ПолучитьСрезДанных(Объект.Дата, Объект.Валюта);
        Если ЗаписьКурсы <> Неопределено Тогда
            Курс = ЗаписьКурсы.Курс;
            Кратность = ЗаписьКурсы.Кратность;
            
            // Сброс значений
            Объект.СуммаВсегоРегл = 0;
            Объект.ОбщаяСуммаВсегоРегл = 0;
            
            // Пересчет по табличной части
            Для Каждого Ряд Из Объект.Товары Цикл
                // Конвертация суммы в рубли
                Ряд.СуммаВсегоРегл = Ряд.СуммаВсего * (Курс / Кратность);
                Ряд.СуммаВсегоРегл = Окр(Ряд.СуммаВсегоРегл, 2);
                
                // Накопление общей суммы
                Объект.ОбщаяСуммаВсегоРегл = Объект.ОбщаяСуммаВсегоРегл + Ряд.СуммаВсегоРегл;
            КонецЦикла;
            
            // Окончательное округление общей суммы
            Объект.ОбщаяСуммаВсегоРегл = Окр(Объект.ОбщаяСуммаВсегоРегл, 2);
        КонецЕсли;
    КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ВвестиДопРасходы(Команда)
    // Используем стандартный диалог ввода числа
    Оповещение = Новый ОписаниеОповещения("ПослеВводаДопРасходов", ЭтотОбъект);
    ПоказатьВводЧисла(Оповещение, , "Введите сумму доп. расходов", 12, 2);
КонецПроцедуры

&НаКлиенте
Процедура ПослеВводаДопРасходов(СуммаДопРасходов, Параметры) Экспорт
    Если СуммаДопРасходов <> Неопределено Тогда
        // Распределение суммы по базе
        МассивКоэффициентов = Новый Массив;
        Для Каждого Ряд Из Объект.Товары Цикл
            МассивКоэффициентов.Добавить(Ряд.Сумма);
        КонецЦикла;
        
        РаспределенныеСуммы = РаспределитьСуммуПропорционально(МассивКоэффициентов, СуммаДопРасходов);
        Для i = 0 По РаспределенныеСуммы.Количество() - 1 Цикл
            Объект.Товары[i].СуммаДопРасходы = РаспределенныеСуммы[i];
        КонецЦикла;
    КонецЕсли;
КонецПроцедуры

&НаКлиенте
Функция РаспределитьСуммуПропорционально(МассивКоэффициентов, Сумма, КоличествоЗнаков = 2)
    // Рассчитаем сумму коэффициентов вручную
    ОбщаяСуммаКоэффициентов = 0;
    Для Каждого Коэффициент Из МассивКоэффициентов Цикл
        ОбщаяСуммаКоэффициентов = ОбщаяСуммаКоэффициентов + Коэффициент;
    КонецЦикла;
    Если ОбщаяСуммаКоэффициентов = 0 Тогда
        Возврат Новый Массив;
    КонецЕсли;
    
    РезультирующийМассив = Новый Массив;
    ОбщаяРаспределеннаяСумма = 0;
    
    Для Каждого Коэффициент Из МассивКоэффициентов Цикл
        Доля = (Коэффициент / ОбщаяСуммаКоэффициентов) * Сумма;
        ОкругленнаяДоля = Окр(Доля, КоличествоЗнаков);
        РезультирующийМассив.Добавить(ОкругленнаяДоля);
        ОбщаяРаспределеннаяСумма = ОбщаяРаспределеннаяСумма + ОкругленнаяДоля;
    КонецЦикла;
    
    // Корректировка на случай расхождений из-за округления
    Если ОбщаяРаспределеннаяСумма <> Сумма Тогда
        Разница = Сумма - ОбщаяРаспределеннаяСумма;
        // Распределяем разницу по первому элементу
        РезультирующийМассив[0] = РезультирующийМассив[0] + Разница;
    КонецЕсли;
    
    Возврат РезультирующийМассив;
КонецФункции

&НаКлиенте
Процедура ТоварыКоличествоПриИзменении(Элемент)
    Ряд = Элемент.Родитель.ТекущиеДанные;
    Ряд.Сумма = Ряд.Количество * Ряд.Цена;
    Ряд.СуммаВсего = Ряд.Сумма + Ряд.СуммаДопРасходы;
КонецПроцедуры

&НаКлиенте
Процедура ТоварыЦенаПриИзменении(Элемент)
    Ряд = Элемент.Родитель.ТекущиеДанные;
    Ряд.Сумма = Ряд.Количество * Ряд.Цена;
    Ряд.СуммаВсего = Ряд.Сумма + Ряд.СуммаДопРасходы;
КонецПроцедуры

&НаКлиенте
Процедура ТоварыСуммаДопРасходыПриИзменении(Элемент)
    Ряд = Элемент.Родитель.ТекущиеДанные;
    Ряд.СуммаВсего = Ряд.Сумма + Ряд.СуммаДопРасходы;
КонецПроцедуры

&НаКлиенте
Процедура ТоварыСуммаВсегоПриИзменении(Элемент)
    // Обработка изменений СуммаВсего (если требуется)
КонецПроцедуры

&НаКлиенте
Процедура ВалютаПриИзменении(Элемент)
    ПересчитатьСуммыРегл();
КонецПроцедуры
