
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	//Вставить содержимое обработчика
КонецПроцедуры

&НаКлиенте
Процедура ВвестиДопРасходы(Команда)
	ПоказатьВводЧисла(Новый ОписаниеОповещения("ОбработкаВводаДопРасходов", ЭтаФорма), "Введите сумму дополнительных расходов");
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаВводаДопРасходов(ВведенноеЧисло, ДополнительныеПараметры) Экспорт
	Если ВведенноеЧисло <> Неопределено Тогда
		Коэффициенты = Новый Массив;
		Для каждого СтрокаТовары Из Объект.Товары Цикл
			Коэффициенты.Добавить(СтрокаТовары.Сумма);
		КонецЦикла;
		РаспределеннаяСумма = РаспределитьСуммуПоБазам(Коэффициенты, ВведенноеЧисло, 2);
		Индекс = 0;
		Для каждого СтрокаТовары Из Объект.Товары Цикл
			СтрокаТовары.СуммаДопРасходы = РаспределеннаяСумма[Индекс];
			Индекс = Индекс + 1;
		КонецЦикла;
		РассчитатьИтогиТаблицыТовары();
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьИтогиТаблицыТовары()
	Для каждого СтрокаТовары Из Объект.Товары Цикл
		СтрокаТовары.СуммаВсего = СтрокаТовары.Сумма + СтрокаТовары.СуммаДопРасходы;
	КонецЦикла;
КонецПроцедуры

&НаСервереБезКонтекста
Функция РаспределитьСуммуПоБазам(КоэффициентыБазы, СуммаДляРаспределения, ЗнаковОкругления = 2)
	СуммаКоэффициентов = 0;
	Для каждого Коэффициент Из КоэффициентыБазы Цикл
		СуммаКоэффициентов = СуммаКоэффициентов + Коэффициент;
	КонецЦикла;
	
	Если СуммаКоэффициентов = 0 Тогда
		РаспределеннаяСумма = Новый Массив;
		Для Индекс = 1 По КоэффициентыБазы.Количество() Цикл
			РаспределеннаяСумма.Добавить(0);
		КонецЦикла;
		Возврат РаспределеннаяСумма;
	КонецЕсли;
	
	РаспределеннаяСумма = Новый Массив(КоэффициентыБазы.Количество());
	ОстатокСуммы = СуммаДляРаспределения;
	
	Для Индекс = 0 По КоэффициентыБазы.Количество() - 2 Цикл
		Доля = (КоэффициентыБазы[Индекс] / СуммаКоэффициентов) * СуммаДляРаспределения;
		ОкругленнаяДоля = Окр(Доля, ЗнаковОкругления);
		РаспределеннаяСумма[Индекс] = ОкругленнаяДоля;
		ОстатокСуммы = ОстатокСуммы - ОкругленнаяДоля;
	КонецЦикла;
	
	РаспределеннаяСумма[КоэффициентыБазы.Количество() - 1] = ОстатокСуммы;
	Возврат РаспределеннаяСумма;
КонецФункции

&НаКлиенте
Процедура ТоварыКоличествоПриИзменении(Элемент)
	РассчитатьСуммуТекущейСтроки();
	РассчитатьСуммуВсего();
КонецПроцедуры

&НаКлиенте
Процедура ТоварыЦенаПриИзменении(Элемент)
	РассчитатьСуммуТекущейСтроки();
	РассчитатьСуммуВсего();
КонецПроцедуры

&НаКлиенте
Процедура ТоварыСуммаДопРасходыПриИзменении(Элемент)
	РассчитатьСуммуВсего();
КонецПроцедуры

&НаКлиенте
Процедура ТоварыСуммаВсегоПриИзменении(Элемент)
	// Вставить содержимое обработчика, если необходимо
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьСуммуТекущейСтроки()
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	Если ТекущаяСтрока <> Неопределено Тогда
		ТекущаяСтрока.Сумма = ТекущаяСтрока.Количество * ТекущаяСтрока.Цена;
		РассчитатьСуммуВсего();
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьСуммуВсего()
	ТекущаяСтрока = Элементы.Товары.ТекущиеДанные;
	Если ТекущаяСтрока <> Неопределено Тогда
		ТекущаяСтрока.СуммаВсего = ТекущаяСтрока.Сумма + ТекущаяСтрока.СуммаДопРасходы;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ВалютаПриИзменении(Элемент)
	// Вставить содержимое обработчика.
КонецПроцедуры
